@{
	ViewData["Title"] = "Add/Edit Student";
}

<div class="container mt-4">
	<h3 class="text-center">Add / Edit Student</h3>
	<form id="studentForm" enctype="multipart/form-data">
		<input type="hidden" id="studentId" name="Id" />

		<div class="form-group">
			<label for="firstName">First Name:</label>
			<input type="text" class="form-control" id="firstName" name="First_Name" />
		</div>

		<div class="form-group">
			<label for="lastName">Last Name:</label>
			<input type="text" class="form-control" id="lastName" name="Last_Name" />
		</div>

		<div class="form-group">
			<label for="rollNumber">Roll Number:</label>
			<input type="number" class="form-control" id="rollNumber" name="Roll_Number" />
		</div>

		<div class="form-group">
			<label for="classId">Class:</label>
			<select class="form-control" id="classId" name="ClassId"></select>
		</div>

		<div class="form-group">
			<label for="sectionId">Section:</label>
			<select class="form-control" id="sectionId" name="SectionId"></select>
		</div>

		<div class="form-group">
			<label for="marks">Marks:</label>
			<input type="number" class="form-control" id="marks" name="Marks" />
		</div>

		<div class="form-group">
			<label for="email">Email:</label>
			<input type="email" class="form-control" id="email" name="Email" />
		</div>

		<div class="form-group">
			<label for="imageFile">Upload Image:</label>
			<input type="file" class="form-control" id="imageFile" name="imageFile" accept="image/*" />
			<img id="imagePreview" src="" class="mt-2 d-none" width="100" height="100" />
		</div>

		<button type="submit" class="btn btn-success mt-3">Save Student</button>
	</form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
	$(document).ready(function () {

		function loadClasses() {
			$.get("/Students/GetAllClasses", function (classes) {
				var classDropdown = $("#classId");
				classDropdown.empty().append('<option value="">--Select Class--</option>');
				$.each(classes, function (index, item) {
					classDropdown.append(`<option value="${item.classID}">${item.className}</option>`);
				});
			});
		}

		function loadSections(classId, selectedSectionId = null) {
			var sectionDropdown = $("#sectionId");
			sectionDropdown.empty().append('<option value="">--Select Section--</option>');

			if (!classId) return;

			$.get("/Students/GetSectionsByClassId", { classId: classId }, function (sections) {
				if (!sections || sections.length === 0) {
					sectionDropdown.append('<option value="">No Sections Available</option>');
					return;
				}

				$.each(sections, function (index, item) {
					sectionDropdown.append(`<option value="${item.sectionId}">${item.sectionName}</option>`);
				});

				if (selectedSectionId) {
					$("#sectionId").val(selectedSectionId);
				}
			}).fail(function () {
				alert("Failed to load sections. Please try again.");
			});
		}

			function loadStudentData() {
		const urlParams = new URLSearchParams(window.location.search);
		const studentId = urlParams.get("id");

		if (studentId) {
			$.get(`/Students/GetStudentById/${studentId}`, function (data) {
				$("#studentId").val(data.id);
				$("#firstName").val(data.first_Name);
				$("#lastName").val(data.last_Name);
				$("#rollNumber").val(data.roll_Number);
				$("#marks").val(data.marks);
				$("#email").val(data.email);

				$.get("/Students/GetAllClasses", function (classes) {
					var classDropdown = $("#classId");
					classDropdown.empty().append('<option value="">--Select Class--</option>');
					$.each(classes, function (index, item) {
						classDropdown.append(`<option value="${item.classID}">${item.className}</option>`);
					});

					$("#classId").val(data.classID); 
					loadSections(data.classID, data.sectionID); 
				});

				if (data.image) {
					$("#imagePreview").attr("src", `/Students/GetStudentImage?id=${data.id}`).removeClass("d-none");
				}

			}).fail(function () {
				alert("Failed to load student data.");
			});
		}
	}


		$("#classId").change(function () {
			var classId = $(this).val();
			loadSections(classId);
		});

		$("#imageFile").change(function () {
			const file = this.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function (e) {
					$("#imagePreview").attr("src", e.target.result).removeClass("d-none");
				};
				reader.readAsDataURL(file);
			}
		});

		$("#studentForm").submit(function (e) {
			e.preventDefault();

			var formData = new FormData(this);

			$.ajax({
				url: "/Students/SaveStudent",
				type: "POST",
				data: formData,
				contentType: false,
				processData: false,
				success: function (response) {
					if (response.success) {
						alert(response.message);
						window.location.href = "/Students/Index";
					} else {
						alert("Error: " + response.message);
					}
				},
				error: function () {
					alert("Failed to save student. Please try again.");
				}
			});
		});

		loadClasses();
		loadStudentData();
	});
</script>
